<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>readme</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="README_files/libs/clipboard/clipboard.min.js"></script>
<script src="README_files/libs/quarto-html/quarto.js"></script>
<script src="README_files/libs/quarto-html/popper.min.js"></script>
<script src="README_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="README_files/libs/quarto-html/anchor.min.js"></script>
<link href="README_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="README_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="README_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="README_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="README_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">




<section id="obsidian-pdf-ocr-clipper" class="level1">
<h1>Obsidian PDF OCR &amp; Clipper</h1>
<p>An AI-powered PDF OCR processing system that converts web PDFs and local PDF files to high-quality Markdown and integrates them into your Obsidian vault.</p>
<p><strong>🌏 <a href="README_ja.md">日本語ドキュメント</a> | <a href="README.md">English Documentation</a></strong></p>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<ul>
<li>Since Obsidian’s web clipper cannot perform OCR processing of PDFs, we built our own system to convert PDFs to Markdown. Utilizing the Gemini API with automatic switching between free and paid APIs for efficient document management.</li>
</ul>
</section>
<section id="system-overview" class="level2">
<h2 class="anchored" data-anchor-id="system-overview">🎯 System Overview</h2>
<section id="key-features" class="level3">
<h3 class="anchored" data-anchor-id="key-features">🌟 Key Features</h3>
<ul>
<li>📄 <strong>PDF OCR Processing</strong>: High-precision Markdown conversion of web/local PDFs</li>
<li>🌐 <strong>Automatic Multilingual Translation</strong>: Automated Japanese translation of English documents</li>
<li>💰 <strong>FREE/PAID API Auto-switching</strong>: Leverages Gemini API’s free tier (as of Aug 19, 2025) with automatic fallback to paid API for large files (&gt;19MB)</li>
<li>📱 <strong>Slack Integration</strong>: Real-time processing status notifications</li>
<li>📊 <strong>Cost Tracking</strong>: Automatic calculation and Slack notification of token usage and costs</li>
<li>🎨 <strong>CSL Compliance</strong>: YAML frontmatter compatible with academic literature management</li>
<li>💡 <strong>Raycast Integration</strong>: Simply copy a URL and type <code>clipPDF</code> in Raycast to convert PDFs to Markdown and save to Obsidian</li>
</ul>
</section>
<section id="workflow" class="level3">
<h3 class="anchored" data-anchor-id="workflow">🔄 Workflow</h3>
<pre class="mermaid"><code>graph TD
    A[PDF/URL] --&gt; B[Size Detection]
    B --&gt;|≤19MB| C[Free API]
    B --&gt;|&gt;19MB| D[Paid API]
    C --&gt; E[OCR Processing]
    D --&gt; E
    E --&gt; F[Multilingual Translation]
    F --&gt; G[Tagging]
    G --&gt; H[Markdown Save]
    H --&gt; I[Slack Notification]</code></pre>
</section>
</section>
<section id="system-architecture" class="level2">
<h2 class="anchored" data-anchor-id="system-architecture">🏗️ System Architecture</h2>
<section id="directory-structure" class="level3">
<h3 class="anchored" data-anchor-id="directory-structure">📁 Directory Structure</h3>
<pre><code>obsidian-vault/
├── .env                      # Environment settings (git-ignored)
├── .env.sample              # Configuration template
├── README.md                # This file
├── README_ja.md             # Japanese documentation
├── script/                  # Execution scripts
│   ├── clipPDF.sh          # Web PDF processing (Raycast frontend)
│   ├── background_ocrPDF.sh # Main OCR processing engine
│   ├── background_slack.sh  # Slack notification module
│   ├── tag.md              # Tag dictionary (optional)
│   └── temp_*/             # Temporary processing directories
├── vault/                   # Obsidian content (configurable)
│   ├── clip/               # Web PDF output
│   ├── scan/               # Local PDF output
│   └── paper/              # Academic literature output
└── attachments/             # Original PDF file storage</code></pre>
</section>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">🛠️ Setup</h2>
<section id="system-requirements" class="level3">
<h3 class="anchored" data-anchor-id="system-requirements">1. System Requirements</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># macOS essential tools</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">brew</span> install poppler jq optipng</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># System commands (usually pre-installed)</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># curl, base64, bc (basic calculations)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="environment-configuration" class="level3">
<h3 class="anchored" data-anchor-id="environment-configuration">2. Environment Configuration</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create configuration file</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> .env.sample .env</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Edit required settings</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="ex">vim</span> .env</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="required-configuration-items" class="level4">
<h4 class="anchored" data-anchor-id="required-configuration-items">Required Configuration Items</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Setting</th>
<th>Description</th>
<th>Source</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>AI_API_KEY</code></td>
<td>Gemini API (basic)</td>
<td><a href="https://makersuite.google.com/app/apikey">Google AI Studio</a></td>
</tr>
<tr class="even">
<td><code>AI_API_KEY_PAID</code></td>
<td>Gemini Paid API (for &gt;19MB)</td>
<td><a href="https://console.cloud.google.com/">Google Cloud Console</a></td>
</tr>
<tr class="odd">
<td><code>SLACK_BOT_TOKEN</code></td>
<td>Slack notifications (optional)</td>
<td><a href="https://api.slack.com/apps">Slack API</a></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="pricing-configuration-important" class="level3">
<h3 class="anchored" data-anchor-id="pricing-configuration-important">3. Pricing Configuration (Important)</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Gemini API pricing (2025 rates)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="va">GEMINI_INPUT_COST_PER_1K</span><span class="op">=</span>0.0025      <span class="co"># $0.0025/1000 tokens</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="va">GEMINI_OUTPUT_COST_PER_1K</span><span class="op">=</span>0.015      <span class="co"># $0.015/1000 tokens</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="va">GEMINI_THOUGHTS_COST_PER_1K</span><span class="op">=</span>0.0025   <span class="co"># $0.0025/1000 tokens</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="usage" class="level2">
<h2 class="anchored" data-anchor-id="usage">🚀 Usage</h2>
<section id="pdf-ocr-processing" class="level3">
<h3 class="anchored" data-anchor-id="pdf-ocr-processing">📄 PDF OCR Processing</h3>
<section id="web-pdfs" class="level4">
<h4 class="anchored" data-anchor-id="web-pdfs">🌐 Web PDFs</h4>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./script/clipPDF.sh</span> <span class="st">"https://example.com/paper.pdf"</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ex">./script/clipPDF.sh</span> <span class="st">"https://example.com/paper.pdf"</span> paper</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="local-pdfs" class="level4">
<h4 class="anchored" data-anchor-id="local-pdfs">📱 Local PDFs</h4>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./script/clipPDF.sh</span> <span class="st">"/path/to/document.pdf"</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">./script/clipPDF.sh</span> <span class="st">"/path/to/document.pdf"</span> scan</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="processing-categories" class="level4">
<h4 class="anchored" data-anchor-id="processing-categories">🎯 Processing Categories</h4>
<ul>
<li><strong>clip</strong>: PDFs from web (default)</li>
<li><strong>scan</strong>: Scanned local PDFs</li>
<li><strong>paper</strong>: Academic papers</li>
</ul>
</section>
</section>
<section id="freepaid-api-auto-switching" class="level3">
<h3 class="anchored" data-anchor-id="freepaid-api-auto-switching">💰 FREE/PAID API Auto-switching</h3>
<p>The system automatically selects the optimal API:</p>
<ul>
<li><strong>≤19MB</strong>: FREE API usage (cost reduction)</li>
<li><strong>&gt;19MB</strong>: PAID API usage (high-speed processing)</li>
<li><strong>Auto fallback</strong>: Only processes ≤19MB files when PAID API key is not configured</li>
</ul>
</section>
<section id="multilingual-translation" class="level3">
<h3 class="anchored" data-anchor-id="multilingual-translation">🌐 Multilingual Translation</h3>
<p>Automatically adds Japanese translation for English documents:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Output Example</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">## Original Content (English)</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>Original English content...</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="fu">## 日本語訳</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>Automatically translated Japanese content...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="hybrid-tagging-system" class="level3">
<h3 class="anchored" data-anchor-id="hybrid-tagging-system">🏷️ Hybrid Tagging System</h3>
<section id="automatic-tag-assignment" class="level4">
<h4 class="anchored" data-anchor-id="automatic-tag-assignment">Automatic Tag Assignment</h4>
<ol type="1">
<li><strong>Required tags</strong>: Processing category (clip/scan/paper), pdf</li>
<li><strong>Standard tags</strong>: 3-5 tags selected from script/tag.md</li>
<li><strong>Dynamic tags</strong>: 2-4 newly created tags specific to document content</li>
</ol>
</section>
<section id="dynamic-tag-examples" class="level4">
<h4 class="anchored" data-anchor-id="dynamic-tag-examples">Dynamic Tag Examples</h4>
<div class="sourceCode" id="cb9"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tags</span><span class="kw">:</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> paper</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> pdf</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> artificial_intelligence</span><span class="co"> # Standard tag</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> machine_learning</span><span class="co"> # Standard tag</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> transformer_architecture</span><span class="co"> # Dynamic tag</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> attention_mechanism</span><span class="co"> # Dynamic tag</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="slack-integration" class="level3">
<h3 class="anchored" data-anchor-id="slack-integration">📱 Slack Integration</h3>
<section id="processing-notifications" class="level4">
<h4 class="anchored" data-anchor-id="processing-notifications">Processing Notifications</h4>
<ol type="1">
<li><strong>Start Notification</strong></li>
</ol>
<pre class="text"><code>@user 🚀 PDF OCR Processing - Started
• URL: https://example.com/paper.pdf</code></pre>
<ol start="2" type="1">
<li><strong>Completion Notification</strong></li>
</ol>
<pre class="text"><code>@user ✅ PDF OCR Processing - Success
• PDF: research_paper.pdf
• md: paper/20250819_research_paper.md
• API: 🆓 Free API / REALTIME mode
• cost: $0.045(i$0.012+t$0.000+o$0.033: total 3,245 tkn)
• time: 2min 30sec</code></pre>
<ol start="3" type="1">
<li><strong>Failure Notification</strong></li>
</ol>
<pre class="text"><code>@user ❌ PDF OCR Processing - Failed
• PDF: large_document.pdf
• message: Large payload requires Paid API key
• API: ❓ Unknown mode
• time: 30sec</code></pre>
</section>
</section>
</section>
<section id="detailed-feature-requirements" class="level2">
<h2 class="anchored" data-anchor-id="detailed-feature-requirements">📊 Detailed Feature Requirements</h2>
<section id="ocr-processing-features" class="level3">
<h3 class="anchored" data-anchor-id="ocr-processing-features">🔍 OCR Processing Features</h3>
<section id="processing-modes" class="level4">
<h4 class="anchored" data-anchor-id="processing-modes">Processing Modes</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 16%">
<col style="width: 23%">
<col style="width: 20%">
<col style="width: 5%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Mode</th>
<th>Features</th>
<th>Processing Time</th>
<th>Cost</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>REALTIME</strong></td>
<td>Immediate results</td>
<td>30sec-5min</td>
<td>High</td>
<td>Urgent docs, small files</td>
</tr>
<tr class="even">
<td><strong>BATCH</strong></td>
<td>Queue processing</td>
<td>Few mins-1hr</td>
<td>Low</td>
<td>Large documents</td>
</tr>
</tbody>
</table>
</section>
<section id="quality-settings" class="level4">
<h4 class="anchored" data-anchor-id="quality-settings">Quality Settings</h4>
<ul>
<li><strong>DPI</strong>: Dynamic adjustment (200-300, optimized by page count)</li>
<li><strong>Optimization</strong>: Automatic PNG compression (optipng)</li>
<li><strong>Language</strong>: Multilingual support (auto-detection &amp; translation)</li>
<li><strong>Structure Preservation</strong>: Faithful reproduction of headings, tables, lists</li>
<li><strong>CSL Compliance</strong>: Academic literature metadata support</li>
</ul>
</section>
</section>
<section id="cost-management" class="level3">
<h3 class="anchored" data-anchor-id="cost-management">💰 Cost Management</h3>
<section id="automatic-cost-calculation" class="level4">
<h4 class="anchored" data-anchor-id="automatic-cost-calculation">Automatic Cost Calculation</h4>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Auto-calculation example on completion</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cost:</span> <span class="va">$2</span>.45<span class="er">(</span><span class="ex">i</span><span class="va">$1</span><span class="ex">.20+t</span><span class="va">$0</span><span class="ex">.00+o</span><span class="va">$1</span><span class="ex">.25:</span> total 163,245 tkn<span class="kw">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="pricing-structure-gemini-2.5-pro" class="level4">
<h4 class="anchored" data-anchor-id="pricing-structure-gemini-2.5-pro">Pricing Structure (Gemini 2.5 Pro)</h4>
<ul>
<li><strong>Input</strong>: $0.0025/1000 tokens</li>
<li><strong>Output</strong>: $0.015/1000 tokens</li>
<li><strong>Thoughts</strong>: $0.0025/1000 tokens</li>
</ul>
</section>
<section id="cost-optimization-features" class="level4">
<h4 class="anchored" data-anchor-id="cost-optimization-features">Cost Optimization Features</h4>
<ol type="1">
<li><strong>Size-based API switching</strong>: Automatic switching at 19MB threshold</li>
<li><strong>PNG optimization</strong>: File size reduction via optipng</li>
<li><strong>Dynamic DPI adjustment</strong>: Quality optimization based on page count</li>
<li><strong>Real-time calculation</strong>: Accurate cost display upon completion</li>
</ol>
</section>
</section>
</section>
<section id="advanced-configuration" class="level2">
<h2 class="anchored" data-anchor-id="advanced-configuration">🔧 Advanced Configuration</h2>
<section id="directory-structure-customization" class="level3">
<h3 class="anchored" data-anchor-id="directory-structure-customization">Directory Structure Customization</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># .env configuration example</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="va">CONTENT_BASE_DIR</span><span class="op">=</span>vault           <span class="co"># Content base directory</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="va">CLIP_OUTPUT_DIR</span><span class="op">=</span>clip            <span class="co"># Web PDF output destination</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="va">PAPER_OUTPUT_DIR</span><span class="op">=</span>paper          <span class="co"># Academic paper output destination</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="va">ATTACHMENTS_DIR</span><span class="op">=</span>attachments     <span class="co"># PDF storage location</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="slack-notification-customization" class="level3">
<h3 class="anchored" data-anchor-id="slack-notification-customization">Slack Notification Customization</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Disable notifications</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="va">SLACK_PROJECT_NOTIFICATIONS</span><span class="op">=</span>false</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Channel settings</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="va">SLACK_REPORT_CHANNEL</span><span class="op">=</span><span class="st">""</span>  <span class="co"># Notification destination channel</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="va">SLACK_MENTION_USER_ID</span><span class="op">=</span><span class="st">""</span>  <span class="co"># Mention target</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="ocr-processing-customization" class="level3">
<h3 class="anchored" data-anchor-id="ocr-processing-customization">OCR Processing Customization</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># AI settings</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="va">AI_PROVIDER</span><span class="op">=</span>gemini             <span class="co"># AI provider (gemini/claude/openai)</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="va">AI_MODEL</span><span class="op">=</span>gemini-2.5-pro        <span class="co"># Model to use</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="va">TEMPERATURE</span><span class="op">=</span>0.1                <span class="co"># AI creativity (low=accurate)</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Processing settings</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="va">PDF_TEMP_BASE_DIR</span><span class="op">=</span>./           <span class="co"># Temporary file storage location</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="troubleshooting" class="level2">
<h2 class="anchored" data-anchor-id="troubleshooting">🚨 Troubleshooting</h2>
<section id="common-issues" class="level3">
<h3 class="anchored" data-anchor-id="common-issues">Common Issues</h3>
<section id="ocr-processing-errors" class="level4">
<h4 class="anchored" data-anchor-id="ocr-processing-errors">1. OCR Processing Errors</h4>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check dependencies</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="ex">brew</span> list <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-E</span> <span class="st">"(poppler|jq)"</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="bu">command</span> <span class="at">-v</span> pdftoppm pdfinfo</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Check logs</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> script/failed_logs/  <span class="co"># Failed log storage location</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="no-slack-notifications" class="level4">
<h4 class="anchored" data-anchor-id="no-slack-notifications">2. No Slack Notifications</h4>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check configuration</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> .env <span class="kw">|</span> <span class="fu">grep</span> SLACK</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Test notification</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST <span class="at">-H</span> <span class="st">"Authorization: Bearer </span><span class="va">$SLACK_BOT_TOKEN</span><span class="st">"</span> <span class="dt">\</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">-H</span> <span class="st">"Content-type: application/json"</span> <span class="dt">\</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">--data</span> <span class="st">'{"channel":"#general","text":"test"}'</span> <span class="dt">\</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  https://slack.com/api/chat.postMessage</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="api-limit-errors" class="level4">
<h4 class="anchored" data-anchor-id="api-limit-errors">3. API Limit Errors</h4>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For large file processing</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># PAID API key required (&gt;19MB)</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="va">AI_API_KEY_PAID</span><span class="op">=</span>your-paid-api-key</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Check API usage</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Monitor usage in Google Cloud Console</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="temporary-file-residue" class="level4">
<h4 class="anchored" data-anchor-id="temporary-file-residue">4. Temporary File Residue</h4>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Manual temporary file cleanup</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> <span class="at">-rf</span> script/temp_<span class="pp">*</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove processing state files</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> <span class="at">-rf</span> script/state/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
</section>
<section id="performance" class="level2">
<h2 class="anchored" data-anchor-id="performance">📈 Performance</h2>
<section id="processing-capacity" class="level3">
<h3 class="anchored" data-anchor-id="processing-capacity">Processing Capacity</h3>
<ul>
<li><strong>PDF Processing</strong>: Average 1-5 min/file (depends on size &amp; page count)</li>
<li><strong>API Response</strong>: REALTIME 30sec-5min, BATCH few mins-1hr</li>
<li><strong>Translation Processing</strong>: Auto-detection &amp; translation (no additional time)</li>
</ul>
</section>
</section>
<section id="use-cases" class="level2">
<h2 class="anchored" data-anchor-id="use-cases">💡 Use Cases</h2>
<section id="academic-research-workflow" class="level3">
<h3 class="anchored" data-anchor-id="academic-research-workflow">📚 Academic Research Workflow</h3>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Process research papers from URLs</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="ex">./script/clipPDF.sh</span> <span class="st">"https://arxiv.org/pdf/2024.12345v1.pdf"</span> paper</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Process local research papers</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="ex">./script/background_ocrPDF.sh</span> <span class="st">"/path/to/research_papers/"</span> paper</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Result: vault/paper/20250819_research_title.md</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co"># CSL-compliant metadata + auto-translation + specialized tagging</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="business-document-management" class="level3">
<h3 class="anchored" data-anchor-id="business-document-management">📋 Business Document Management</h3>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Process scanned documents</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="ex">./script/clipPDF.sh</span> <span class="st">"/path/to/scanned/contracts.pdf"</span> scan</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Process web PDFs</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="ex">./script/clipPDF.sh</span> <span class="st">"https://company.com/annual_report.pdf"</span> clip</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Result: Auto-classification + Slack notifications + cost tracking</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="daily-pdf-processing" class="level3">
<h3 class="anchored" data-anchor-id="daily-pdf-processing">📱 Daily PDF Processing</h3>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># One-click execution from Raycast</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># URL input → Auto-processing → Obsidian save → Slack notification</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Markdown output features:</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - CSL-compliant metadata</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co"># - Multilingual translation</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co"># - Hybrid tagging</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co"># - PDF links (relative &amp; absolute paths)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="the-power-of-raycast-integration" class="level2">
<h2 class="anchored" data-anchor-id="the-power-of-raycast-integration">🌟 The Power of Raycast Integration</h2>
<p>Combining with Raycast makes PDF processing remarkably simple:</p>
<section id="one-click-processing" class="level3">
<h3 class="anchored" data-anchor-id="one-click-processing">✨ One-Click Processing</h3>
<ol type="1">
<li><strong>Copy PDF URL</strong> - Copy research paper or document PDF link from browser</li>
<li><strong>Launch Raycast</strong> - Open Raycast with <code>Cmd + Space</code></li>
<li><strong>Execute clipPDF</strong> - Type <code>clipPDF</code> and paste URL</li>
<li><strong>Auto-completion</strong> - Background processing completes, confirmed via Slack notification</li>
</ol>
</section>
<section id="efficient-workflow" class="level3">
<h3 class="anchored" data-anchor-id="efficient-workflow">🎯 Efficient Workflow</h3>
<pre class="text"><code>Discover Paper → Copy URL → Raycast → clipPDF → Completion Notification
     ↓
Immediately searchable &amp; referenceable high-quality Markdown in Obsidian</code></pre>
</section>
<section id="use-scenarios" class="level3">
<h3 class="anchored" data-anchor-id="use-scenarios">💡 Use Scenarios</h3>
<ul>
<li><strong>Research</strong>: Instant Markdown conversion upon discovering ArXiv papers</li>
<li><strong>Business</strong>: Immediate Obsidian integration of internal documents and reports</li>
<li><strong>Learning</strong>: Systematic management of technical documents and manuals</li>
</ul>
<hr>
<p><strong>🎯 With Raycast integration, PDF processing becomes part of your daily routine. Start efficient knowledge management today!</strong></p>
</section>
</section>
<section id="license" class="level2">
<h2 class="anchored" data-anchor-id="license">📄 License</h2>
<p>MIT License</p>
</section>
<section id="contributing" class="level2">
<h2 class="anchored" data-anchor-id="contributing">🤝 Contributing</h2>
<p>Issues and Pull Requests are welcome. We especially appreciate contributions in the following areas:</p>
<ul>
<li>Support for new AI providers</li>
<li>OCR accuracy improvements</li>
<li>UI enhancements</li>
<li>Documentation improvements</li>
</ul>
<hr>
<p><strong>🌏 <a href="README_ja.md">日本語ドキュメント</a> | <a href="README.md">English Documentation</a></strong></p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>